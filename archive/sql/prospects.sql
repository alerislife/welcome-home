-- DDL for sql table
CREATE OR REPLACE TABLE {database}.{schema}.prospects (
    id INTEGER PRIMARY KEY,
    created_at TIMESTAMP_TZ,
    active_at TIMESTAMP_TZ,
    inquiry_date DATE,
    discarded_at TIMESTAMP_TZ,
    referrer_id INTEGER,
    import_id INTEGER,
    status VARCHAR,
    status_changed_at TIMESTAMP_TZ,
    stage_id INTEGER,
    stage_name VARCHAR,
    lead_source_id INTEGER,
    lead_source_name VARCHAR,
    secondary_lead_source_id INTEGER,
    secondary_lead_source_name VARCHAR,
    community_id INTEGER,
    community_name VARCHAR,
    user_name VARCHAR,
    expected_stay_type INTEGER,
    close_reason_id INTEGER,
    close_reason_name VARCHAR,
    close_reason_details TEXT,
    score_name VARCHAR,
    story TEXT,
    metadata VARIANT,
    original_user_name VARCHAR,
    projected_deposit_received_on_date VARCHAR,
    projected_move_in_date VARCHAR,
    original_prospect_id INTEGER,
    start_speed_to_lead_clock_at TIMESTAMP_TZ,
    start_business_hours_speed_to_lead_clock_at TIMESTAMP_TZ,
    end_speed_to_lead_clock_at TIMESTAMP_TZ,
    load_dts TIMESTAMP_TZ
);

-- COPY INTO statement to load data
COPY INTO
    {database}.{schema}.prospects (
    id,
    created_at,
    active_at,
    inquiry_date,
    discarded_at,
    referrer_id,
    import_id,
    status,
    status_changed_at,
    stage_id,
    stage_name,
    lead_source_id,
    lead_source_name,
    secondary_lead_source_id,
    secondary_lead_source_name,
    community_id,
    community_name,
    user_name,
    expected_stay_type,
    close_reason_id,
    close_reason_name,
    close_reason_details,
    score_name,
    story,
    metadata,
    original_user_name,
    projected_deposit_received_on_date,
    projected_move_in_date,
    original_prospect_id,
    start_speed_to_lead_clock_at,
    start_business_hours_speed_to_lead_clock_at,
    end_speed_to_lead_clock_at,
    load_dts
)
FROM (
    SELECT
        $1::INTEGER AS id,
        $2::TIMESTAMP_TZ AS created_at,
        IFF($3 = '', NULL, $3::TIMESTAMP_TZ) AS active_at,
        IFF($4 = '', NULL, $4::DATE) AS inquiry_date,
        IFF($5 = '', NULL, $5::TIMESTAMP_TZ) AS discarded_at,
        IFF($6 = '', NULL, $6::INTEGER) AS referrer_id,
        IFF($7 = '', NULL, $7::INTEGER) AS import_id,
        $8::VARCHAR AS status,
        IFF($9 = '', NULL, $9::TIMESTAMP_TZ) AS status_changed_at,
        IFF($10 = '', NULL, $10::INTEGER) AS stage_id,
        IFF($11 = '', NULL, $11::VARCHAR) AS stage_name,
        IFF($12 = '', NULL, $12::INTEGER) AS lead_source_id,
        IFF($13 = '', NULL, $13::VARCHAR) AS lead_source_name,
        IFF($14 = '', NULL, $14::INTEGER) AS secondary_lead_source_id,
        IFF($15 = '', NULL, $15::VARCHAR) AS secondary_lead_source_name,
        $16::INTEGER AS community_id,
        $17::VARCHAR AS community_name,
        IFF($18 = '', NULL, $18::VARCHAR) AS user_name,
        IFF($19 = '', NULL, $19::INTEGER) AS expected_stay_type,
        IFF($20 = '', NULL, $20::INTEGER) AS close_reason_id,
        IFF($21 = '', NULL, $21::VARCHAR) AS close_reason_name,
        IFF($22 = '', NULL, $22::TEXT) AS close_reason_details,
        IFF($23 = '', NULL, $23::VARCHAR) AS score_name,
        IFF($24 = '', NULL, $24::TEXT) AS story,
        IFF($25 = '{{}}' OR $25 = '', NULL, PARSE_JSON($25)) AS metadata,
        IFF($26 = '', NULL, $26::VARCHAR) AS original_user_name,
        IFF($27 = '', NULL, $27::VARCHAR) AS projected_deposit_received_on_date,
        IFF($28 = '', NULL, $28::VARCHAR) AS projected_move_in_date,
        IFF($29 = '', NULL, $29::INTEGER) AS original_prospect_id,
        IFF($30 = '', NULL, $30::TIMESTAMP_TZ) AS start_speed_to_lead_clock_at,
        IFF($31 = '', NULL, $31::TIMESTAMP_TZ) AS start_business_hours_speed_to_lead_clock_at,
        IFF($32 = '', NULL, $32::TIMESTAMP_TZ) AS end_speed_to_lead_clock_at,
        CONVERT_TIMEZONE('America/New_York', CURRENT_TIMESTAMP()) AS load_dts
    FROM @{stage_name}/{blob_name}
)
FILE_FORMAT = (FORMAT_NAME = 'csv_format');
